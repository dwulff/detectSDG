---
title: "Using text2sdg"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{using_text2sdg}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, fig.height=4
)
```

```{r setup}
library(text2sdg)
```

# Intro

The United Nationsâ€™ Sustainable Development Goals (SDGs) have become an important guideline for organizations to monitor and plan their contributions to social, economic, and environmental transformations. Existing approaches to identify efforts addressing each of the 17 goals rely on economic indicators or, in the case of academic output, on search engines of academic data bases. `text2sdg` is the first open source, multi-system tool to detect SDGs in text.     

The `text2sdg` package consists of three core functions: `detect_sdg()`, `plot_sdg()`, and `crosstab_sdg()`. The function `detect_sdg()` carries out the detection of SDGs in text using a maximum of five different search systems. The functions `plot_sdg()` and `crosstab_sdg()` help visualize and analyze the resulting SDG matches. 

# Detecting SDGs using `detect_sdg()`

The `detect_sdg()` identifies SDGs in texts that are provided via the `text` argument. Inputs to `text` must either be a character vector or an object of `tCorpus` from package `corpustools`. `text` is the only non-default argument of the function, which means that the function can be run with only the texts as input. The output of the function is a `tibble` with one row per match including the following columns (and types):

- `document` (`factor`) - index of element in the character vector or corpus supplie for `text`
- `sdg` (`character`) - labels indicating the matched SDGs
- `system` (`character`) - the search system that produced the match
- `query_id` (`integer`) - identifier of query in the search system
- `features` (`character`) - words in the document that were matched by the query
- `hit` (`numeric`) - running index of matches for each search system

The example below runs the `detect_sdg()` for the `projects` data set included in the package prints the results. The data set is character vector containing 500 descriptions of University of Basel research projects that were funded by the Swiss National Science Foundation (<a href="https://p3.snf.ch">https://p3.snf.ch</a>). The analysis produced a total of `462` matches using the three default searchs systems Aurora, Elsevier, and SIRIS.   

```{r}
# detecting SDGs in projects
hits_default <- detect_sdg(projects)
hits_default
```

## Search systems 

By default `sdg_detect()` runs the three query-based search systems, Aurora, Elsevier, and SIRIS. Using the `system` argument the function the user can control the systems that are run. There are two additional keyword-based systems that can be selected, Ontology and SDSN. In comparison, the two keyword-based systems tend to identify a much larger number of SDGs compared to the query-based search systems. Systematic validations are outstanding, however, it is likely that keyword-based systems produce a larger number of false positives, which is the reason they are not included in the function's default search system set. 

The code below runs the `detect_sdg()` on the `projects` for each search system individually, including the two keyword baed system. The resulting `tibble`s reveal that Aurora is most conservative (60 hits), followed by SIRIS (167), Elsevier (235), and then with large margin the two keyword-based systems SDSN (2,575) and Ontology (3,617). Note that the high numbers for the two keyword-based systems imply that, on average, 5 respectively 7 SDGs are identified per document. 

```{r, echo = F}
options(tibble.print_min = 5)
```

```{r}
# detecting SDGs using all available search systems
hits_all <- detect_sdg(projects, 
                       system = c("aurora", "elsevier", "siris", "ontology", "sdsn"))

# count hits of systems
table(hits_all$system)
```

```{r, echo = F}
options(tibble.print_min = 10)
```

## SDGs

By default the `detect_sdg()` function runs all SDGs for which queries exist, which is all 17 for Aurora, Ontology, and SDSN, and 16 for Elsevier and Siris. The latter two do not include queries for gaol 17 - Global Partnerships for the Goals. If the user is only interested in a subset of SDGs or wants to reduce runtime, the `sdgs` argument can be used to run subsets of SDGs. The argument takes a numeric vector with integers in [1,17] indiciating the SDGs that shall be detected. 

The code below runs the `detect_sdg()` function only for SDGs 1, 2, 3, 4, and 5. 

```{r}
# detecting only for SDGs 1 to 5
hits_sdg_subset <- detect_sdg(projects, sdgs = 1:5)
hits_sdg_subset
```

## Ouptut

By default the output of the `detect_sdg()` function returns matches at the query level. This means one SDG can be matched multiple times for one document, in the case that multiple queries of a given system belonging to the same SDGs produce hits for the same document. On this level it is meaningful to return the features (individual words) that were matched by the queries, which is why we refer to this output type as `"features"`. If the user is only interested in matches at the level of documents, a reduced output can be selected by setting the `output` argument to `"documents"`. As a result, the `detect_sdg()` returns a `tibble` that includes only single matches per `document`, `system`, and `sdg` combinations and drops the columns `query_id` and `features`.  

The code below shows the alternative output resulting from setting `output = "documents"`. 

```{r}
# return documents output format
detect_sdg(projects, output = "documents")
```


## Verbose

By default the `detect_sdg()` function prints messages whenever it begins running a search system. This can help track the progress of the function, which for large number of texts can take several minutes. To suppress these messages, the user can set the `verbose` argument to `FALSE`. 

# Visualizing SDGs hits with `plot_sdg()`

To visualize the hits produced by `detect_sdg`, the `text2sdg` package provides the function `plot_sdg()`. The function produces barplots illustrating either the absolute or relative frequencies produced by the different search systems. It is build on the ggplot2 package, which provides high levels of flexibility for adapting and extending the visualizations.  

By default `plot_sdg()` produces a stacked barplot of absolute hit frequencies for each of the systems and sdgs included in the `tibble` of hits provided to its `hits` argument. The code below  


# Correspondence between SDGs and Systems


We demonstrate the use of `detect_sdg` using the `abstracts` data set included in the `text2sdg` package. It includes 100 abstracts from academic publications. To detect all SDGs in the abstracts using all systems, run the following code. 


Since `verbose = TRUE` by defaul, the function is informs us that the SDGs are identified system by system, and after a few seconds we see the resulting output (a tibble with six columns). The output tells us which SDG was detected in which document by which system (columns one to three). It also tells us which query and features produced the hit. The last column is the hit index for a given system. 

This output is informative, but does not provide a good overview of which sDGs have been detected in the text. This is where the `plot_sdg()` function comes into play. `plot_sdg()` takes the output of `detect_sdg()` as input.
```{r}
plot_sdg(sdgs_default)
```

The output of `plot_sdg()` is a stacked bar chart that shows you how often a SDG was detected by a given system in the text that you fed to `detect_sdg()`. There are a few more arguments that you can specify. As with the `detect_sdg()` function, you can subset the systems and SDGs that you want to show with `systems` and `sdgs` respectively. The `normalize` argument allows you to normalize the frequencies using either the total frequencies of each system `normalize = "systems"` or the total number of documents `normalize = "documents"`. There are a few more arguments that allow you to customize the appearance of the plot. The plot below shows you the normalized frequency (by system) of SDGs 03, 10, and 13 for the systems Aurora and Elsevier and sdsn.
```{r}
plot_sdg(hits_default, sdgs = c(3, 10, 13), systems = c("aurora", "elsevier", "sdsn"), normalize = "documents")
```


Once you have an overiview about which SDGs were matched how often by which system, you might want to see which SDGs co-occured in the text. You can do this with the `crosstab_sdg()` function. It also takes the output of `detect_sdg()` as input.

```{r}
sdg_corr <- crosstab_sdg(hits_default, compare = "sdgs")
```

The output is a correlation matrix, which we visualize with the `corrplot()` function from the `corrplot` package. 

```{r}
corrplot::corrplot(sdg_corr)
```

Like this we can easily see which SDGs co-occur in the text and which do not. As with the previous functions, we can subset both the SDGs and the systems (with the same arguments as in the other functions).

You might also be interested in whether the different systems reach similar conlusions regarding whether an SDG is present in your documents or not. We can also use the `crosstab_sdg()` function for this but specify `compare = "systems"`.

```{r}
systems_corr <- crosstab_sdg(hits_default, compare = "systems")
corrplot::corrplot(systems_corr)
```

We see that all but the Elsevier and Aurora systems correlate positively with each other, meaning they reach similar conclusions regarding whether a SDG is present in a document or not. 



